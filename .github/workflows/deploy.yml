name: ğŸš€ Despliegue Multi-Entorno - Metaverso Web3

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno de despliegue'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
        - canary

env:
  NODE_VERSION: '18'
  IPFS_GATEWAY: 'https://ipfs.io/ipfs/'
  ARWEAVE_GATEWAY: 'https://arweave.net/'
  PRIVATE_KEY: ${{ secrets.PRIVATE_KEY || '' }}
  INFURA_URL: ${{ secrets.INFURA_URL || '' }}
  ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY || '' }}
  POLYGON_RPC: ${{ secrets.POLYGON_RPC || '' }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN || '' }}
  NETLIFY_TOKEN: ${{ secrets.NETLIFY_TOKEN || '' }}
  VERCEL_URL: ${{ secrets.VERCEL_URL || '' }}
  NETLIFY_URL: ${{ secrets.NETLIFY_URL || '' }}
  CLOUDFLARE_URL: ${{ secrets.CLOUDFLARE_URL || '' }}
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK || '' }}

jobs:
  # ğŸ—ï¸ BUILD
  build:
    name: ğŸ—ï¸ Build Multi-MÃ³dulo
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ¦€ Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          cd client && npm ci
          cd ../gateway && npm ci
          cd ../protocol && npm ci
          cd ../engine && cargo build --release
          
      - name: ğŸ—ï¸ Build Client
        run: |
          echo "ğŸ—ï¸ Construyendo cliente..."
          cd client
          npm run build
          
      - name: ğŸ—ï¸ Build Gateway
        run: |
          echo "ğŸ—ï¸ Construyendo gateway..."
          cd gateway
          npm run build
          
      - name: ğŸ—ï¸ Build Engine
        run: |
          echo "ğŸ—ï¸ Construyendo engine..."
          cd engine
          wasm-pack build --target web
          
      - name: ğŸ“¦ Package Assets
        run: |
          echo "ğŸ“¦ Empaquetando assets..."
          node .bin/builder/optimize-assets.js --package
          
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            client/dist/
            gateway/dist/
            engine/pkg/
            assets/processed/

  # â›“ï¸ BLOCKCHAIN DEPLOYMENT
  blockchain-deploy:
    name: â›“ï¸ Despliegue Blockchain
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 45
    
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Foundry
        run: |
          curl -L https://foundry.paradigm.xyz | bash
          source ~/.bashrc
          foundryup
          
      - name: ğŸ” Setup Secrets
        run: |
          echo "ğŸ” Configurando secretos..."
          echo ${{ env.PRIVATE_KEY }} > .env
          echo ${{ env.INFURA_URL }} >> .env
          echo ${{ env.ETHERSCAN_API_KEY }} >> .env
          
      - name: ğŸ—ï¸ Compile Contracts
        run: |
          echo "ğŸ—ï¸ Compilando contratos..."
          cd protocol
          forge build
          
      - name: ğŸš€ Deploy to Ethereum
        run: |
          echo "ğŸš€ Desplegando a Ethereum..."
          cd protocol
          forge script Deploy --rpc-url ${{ env.INFURA_URL }} --broadcast --verify
          
      - name: ğŸš€ Deploy to Polygon
        run: |
          echo "ğŸš€ Desplegando a Polygon..."
          cd protocol
          forge script Deploy --rpc-url ${{ env.POLYGON_RPC }} --broadcast --verify
          
      - name: ğŸ“Š Contract Verification
        run: |
          echo "ğŸ“Š Verificando contratos..."
          node .bin/blockchain/verify-contracts.js
          
      - name: ğŸ“¤ Upload Contract Addresses
        uses: actions/upload-artifact@v4
        with:
          name: contract-addresses
          path: protocol/deployments/

  # ğŸŒ IPFS DEPLOYMENT
  ipfs-deploy:
    name: ğŸŒ Despliegue IPFS
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          
      - name: ğŸ”§ Setup IPFS
        run: |
          echo "ğŸ”§ Configurando IPFS..."
          npm install -g ipfs-cli
          
      - name: ğŸ“¤ Upload to IPFS
        run: |
          echo "ğŸ“¤ Subiendo a IPFS..."
          node .bin/toolkit/ipfs-upload.js --path=client/dist --pin=true
          
      - name: ğŸ”— Update IPFS Links
        run: |
          echo "ğŸ”— Actualizando enlaces IPFS..."
          node .bin/toolkit/update-ipfs-links.js

  # ğŸ“¦ ARWEAVE DEPLOYMENT
  arweave-deploy:
    name: ğŸ“¦ Despliegue Arweave
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 25
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          
      - name: ğŸ”§ Setup Arweave
        run: |
          echo "ğŸ”§ Configurando Arweave..."
          npm install -g arweave-cli
          
      - name: ğŸ“¤ Upload to Arweave
        run: |
          echo "ğŸ“¤ Subiendo a Arweave..."
          node .bin/toolkit/arweave-upload.js --path=client/dist --permanent=true
          
      - name: ğŸ”— Update Arweave Links
        run: |
          echo "ğŸ”— Actualizando enlaces Arweave..."
          node .bin/toolkit/update-arweave-links.js

  # ğŸ® METAVERSE DEPLOYMENT
  metaverse-deploy:
    name: ğŸ® Despliegue Metaverso
    runs-on: ubuntu-latest
    needs: [blockchain-deploy, ipfs-deploy, arweave-deploy]
    timeout-minutes: 30
    
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./
        continue-on-error: true
          
      - name: ğŸ“¦ Download Contract Addresses
        uses: actions/download-artifact@v4
        with:
          name: contract-addresses
          path: ./
        continue-on-error: true
          
      - name: ğŸ”§ Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸš€ Deploy to Vercel
        run: |
          echo "ğŸš€ Desplegando a Vercel..."
          npm install -g vercel
          vercel --prod --token ${{ env.VERCEL_TOKEN }}
          
      - name: ğŸš€ Deploy to Netlify
        run: |
          echo "ğŸš€ Desplegando a Netlify..."
          npm install -g netlify-cli
          netlify deploy --prod --dir=client/dist --token=${{ env.NETLIFY_TOKEN }}
          
      - name: ğŸš€ Deploy to Cloudflare
        run: |
          echo "ğŸš€ Desplegando a Cloudflare..."
          npm install -g wrangler
          wrangler pages publish client/dist --project-name=metaverso-web3
          
      - name: ğŸ® Update Metaverse Config
        run: |
          echo "ğŸ® Actualizando configuraciÃ³n del metaverso..."
          node .bin/metaverso/update-config.js --env=${{ github.event.inputs.environment || 'staging' }}

  # ğŸ” HEALTH CHECK
  health-check:
    name: ğŸ” VerificaciÃ³n de Salud
    runs-on: ubuntu-latest
    needs: metaverse-deploy
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ” Health Check - Vercel
        run: |
          echo "ğŸ” Verificando Vercel..."
          curl -f ${{ env.VERCEL_URL }}/health || exit 1
          
      - name: ğŸ” Health Check - Netlify
        run: |
          echo "ğŸ” Verificando Netlify..."
          curl -f ${{ env.NETLIFY_URL }}/health || exit 1
          
      - name: ğŸ” Health Check - Cloudflare
        run: |
          echo "ğŸ” Verificando Cloudflare..."
          curl -f ${{ env.CLOUDFLARE_URL }}/health || exit 1
          
      - name: ğŸ” Blockchain Health
        run: |
          echo "ğŸ” Verificando blockchain..."
          node .bin/blockchain/health-check.js
          
      - name: ğŸ“Š Performance Test
        run: |
          echo "ğŸ“Š Test de rendimiento..."
          node .bin/monitor/performance-check.js --deployment

  # ğŸ“¢ NOTIFICATIONS
  notifications:
    name: ğŸ“¢ Notificaciones
    runs-on: ubuntu-latest
    needs: [metaverse-deploy, health-check]
    if: always()
    
    steps:
      - name: ğŸ“¢ Slack Notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#metaverso-deployments'
          webhook_url: ${{ env.SLACK_WEBHOOK }}
          
      - name: ğŸ“§ Email Notification
        run: |
          echo "ğŸ“§ Enviando notificaciÃ³n por email..."
          node .bin/toolkit/send-report.js --type=deploy --status=${{ job.status }}
          
      - name: ğŸ¦ Twitter Announcement
        run: |
          echo "ğŸ¦ Anunciando en Twitter..."
          node .bin/toolkit/social-announce.js --platform=twitter --type=deploy
          
      - name: ğŸ“± Discord Notification
        run: |
          echo "ğŸ“± Notificando en Discord..."
          node .bin/toolkit/discord-notify.js --type=deploy --status=${{ job.status }} 