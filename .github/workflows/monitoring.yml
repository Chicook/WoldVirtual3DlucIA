name: ğŸ“Š Monitoreo Continuo - Metaverso Web3

on:
  schedule:
    - cron: '*/5 * * * *'  # Cada 5 minutos
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Tipo de verificaciÃ³n'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - performance
        - blockchain
        - assets
        - security

env:
  NODE_VERSION: '18'
  CHECK_INTERVAL: '300'  # 5 minutos
  VERCEL_URL: ${{ secrets.VERCEL_URL || '' }}
  NETLIFY_URL: ${{ secrets.NETLIFY_URL || '' }}
  CLOUDFLARE_URL: ${{ secrets.CLOUDFLARE_URL || '' }}
  IPFS_GATEWAY: ${{ secrets.IPFS_GATEWAY || '' }}
  ARWEAVE_GATEWAY: ${{ secrets.ARWEAVE_GATEWAY || '' }}

jobs:
  # ğŸ” HEALTH CHECK
  health-check:
    name: ğŸ” Health Check General
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Monitoring Tools
        run: |
          npm install -g lighthouse
          npm install -g webpagetest
          
      - name: ğŸ” Check Vercel Health
        run: |
          echo "ğŸ” Verificando Vercel..."
          curl -f ${{ env.VERCEL_URL }}/health || echo "âŒ Vercel down"
          
      - name: ğŸ” Check Netlify Health
        run: |
          echo "ğŸ” Verificando Netlify..."
          curl -f ${{ env.NETLIFY_URL }}/health || echo "âŒ Netlify down"
          
      - name: ğŸ” Check Cloudflare Health
        run: |
          echo "ğŸ” Verificando Cloudflare..."
          curl -f ${{ env.CLOUDFLARE_URL }}/health || echo "âŒ Cloudflare down"
          
      - name: ğŸ” Check IPFS Gateway
        run: |
          echo "ğŸ” Verificando IPFS..."
          curl -f ${{ env.IPFS_GATEWAY }}/health || echo "âŒ IPFS down"
          
      - name: ğŸ” Check Arweave Gateway
        run: |
          echo "ğŸ” Verificando Arweave..."
          curl -f ${{ env.ARWEAVE_GATEWAY }}/health || echo "âŒ Arweave down"

  # ğŸ“Š PERFORMANCE MONITORING
  performance-monitoring:
    name: ğŸ“Š Monitoreo de Rendimiento
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Performance Tools
        run: |
          npm install -g lighthouse
          npm install -g webpagetest
          
      - name: ğŸ“Š Lighthouse Audit
        run: |
          echo "ğŸ“Š Ejecutando Lighthouse audit..."
          lighthouse ${{ env.VERCEL_URL }} --output=json --output-path=./lighthouse-report.json
          
      - name: ğŸ“Š WebPageTest
        run: |
          echo "ğŸ“Š Ejecutando WebPageTest..."
          webpagetest test ${{ env.VERCEL_URL }} --key=${{ secrets.WEBPAGETEST_KEY }}
          
      - name: ğŸ“Š Performance Analysis
        run: |
          echo "ğŸ“Š Analizando rendimiento..."
          node .bin/monitor/analyze-performance.js --report=lighthouse-report.json
          
      - name: ğŸ“¤ Upload Performance Report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: |
            lighthouse-report.json
            performance-analysis.json

  # â›“ï¸ BLOCKCHAIN MONITORING
  blockchain-monitoring:
    name: â›“ï¸ Monitoreo Blockchain
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Blockchain Tools
        run: |
          npm install -g ethers
          npm install -g web3
          
      - name: ğŸ” Check Ethereum Network
        run: |
          echo "ğŸ” Verificando red Ethereum..."
          node .bin/blockchain/check-network.js --network=ethereum
          
      - name: ğŸ” Check Polygon Network
        run: |
          echo "ğŸ” Verificando red Polygon..."
          node .bin/blockchain/check-network.js --network=polygon
          
      - name: ğŸ” Check Smart Contracts
        run: |
          echo "ğŸ” Verificando smart contracts..."
          node .bin/blockchain/check-contracts.js
          
      - name: ğŸ“Š Gas Price Monitoring
        run: |
          echo "ğŸ“Š Monitoreando precios de gas..."
          node .bin/blockchain/monitor-gas.js
          
      - name: ğŸ“Š Transaction Monitoring
        run: |
          echo "ğŸ“Š Monitoreando transacciones..."
          node .bin/blockchain/monitor-transactions.js
          
      - name: ğŸ“¤ Upload Blockchain Report
        uses: actions/upload-artifact@v4
        with:
          name: blockchain-report
          path: |
            blockchain-health.json
            gas-report.json
            transaction-report.json

  # ğŸ® METAVERSE MONITORING
  metaverse-monitoring:
    name: ğŸ® Monitoreo del Metaverso
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ” Check 3D Assets
        run: |
          echo "ğŸ” Verificando assets 3D..."
          node .bin/metaverso/check-assets.js
          
      - name: ğŸ” Check World Loading
        run: |
          echo "ğŸ” Verificando carga de mundos..."
          node .bin/metaverso/check-worlds.js
          
      - name: ğŸ” Check User Sessions
        run: |
          echo "ğŸ” Verificando sesiones de usuario..."
          node .bin/metaverso/check-sessions.js
          
      - name: ğŸ“Š Performance Metrics
        run: |
          echo "ğŸ“Š MÃ©tricas de rendimiento..."
          node .bin/metaverso/performance-metrics.js
          
      - name: ğŸ“¤ Upload Metaverse Report
        uses: actions/upload-artifact@v4
        with:
          name: metaverse-report
          path: |
            assets-health.json
            worlds-health.json
            sessions-report.json
            performance-metrics.json

  # ğŸ”’ SECURITY MONITORING
  security-monitoring:
    name: ğŸ”’ Monitoreo de Seguridad
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Security Tools
        run: |
          npm install -g snyk
          npm install -g auditjs
          
      - name: ğŸ” Dependency Security Check
        run: |
          echo "ğŸ” Verificando seguridad de dependencias..."
          npm audit --audit-level=moderate
          snyk test --severity-threshold=high
          
      - name: ğŸ” Smart Contract Security
        run: |
          echo "ğŸ” Verificando seguridad de smart contracts..."
          node .bin/security/check-contracts.js
          
      - name: ğŸ” Asset Security Check
        run: |
          echo "ğŸ” Verificando seguridad de assets..."
          node .bin/security/check-assets.js
          
      - name: ğŸ“Š Security Report
        run: |
          echo "ğŸ“Š Generando reporte de seguridad..."
          node .bin/security/generate-report.js
          
      - name: ğŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: |
            security-audit.json
            vulnerability-report.json

  # ğŸ“ˆ ANALYTICS
  analytics:
    name: ğŸ“ˆ Analytics y MÃ©tricas
    runs-on: ubuntu-latest
    needs: [health-check, performance-monitoring, blockchain-monitoring, metaverse-monitoring, security-monitoring]
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Download All Reports
        uses: actions/download-artifact@v4
        with:
          name: performance-report
          path: ./reports/performance
        continue-on-error: true
          
      - name: ğŸ“¦ Download Blockchain Reports
        uses: actions/download-artifact@v4
        with:
          name: blockchain-report
          path: ./reports/blockchain
        continue-on-error: true
          
      - name: ğŸ“¦ Download Metaverse Reports
        uses: actions/download-artifact@v4
        with:
          name: metaverse-report
          path: ./reports/metaverse
        continue-on-error: true
          
      - name: ğŸ“¦ Download Security Reports
        uses: actions/download-artifact@v4
        with:
          name: security-report
          path: ./reports/security
        continue-on-error: true
          
      - name: ğŸ“Š Generate Analytics Report
        run: |
          echo "ğŸ“Š Generando reporte de analytics..."
          node .bin/monitor/generate-analytics.js
          
      - name: ğŸ“¤ Upload Analytics Report
        uses: actions/upload-artifact@v4
        with:
          name: analytics-report
          path: ./reports/analytics.json

  # ğŸš¨ ALERTS
  alerts:
    name: ğŸš¨ Sistema de Alertas
    runs-on: ubuntu-latest
    needs: analytics
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Download Analytics Report
        uses: actions/download-artifact@v4
        with:
          name: analytics-report
          path: ./
        continue-on-error: true
          
      - name: ğŸš¨ Check Critical Alerts
        run: |
          echo "ğŸš¨ Verificando alertas crÃ­ticas..."
          node .bin/monitor/check-alerts.js
          
      - name: ğŸ“¢ Send Slack Alerts
        run: |
          echo "ğŸ“¢ Enviando alertas a Slack..."
          node .bin/toolkit/send-alerts.js --platform=slack
          
      - name: ğŸ“§ Send Email Alerts
        run: |
          echo "ğŸ“§ Enviando alertas por email..."
          node .bin/toolkit/send-alerts.js --platform=email
          
      - name: ğŸ“± Send Discord Alerts
        run: |
          echo "ğŸ“± Enviando alertas a Discord..."
          node .bin/toolkit/send-alerts.js --platform=discord

  # ğŸ“Š DASHBOARD UPDATE
  dashboard-update:
    name: ğŸ“Š Actualizar Dashboard
    runs-on: ubuntu-latest
    needs: analytics
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Download Analytics Report
        uses: actions/download-artifact@v4
        with:
          name: analytics-report
          path: ./
        continue-on-error: true
          
      - name: ğŸ“Š Update Dashboard
        run: |
          echo "ğŸ“Š Actualizando dashboard..."
          node .bin/monitor/update-dashboard.js
          
      - name: ğŸ“Š Update Metrics
        run: |
          echo "ğŸ“Š Actualizando mÃ©tricas..."
          node .bin/monitor/update-metrics.js
          
      - name: ğŸ“Š Generate Status Page
        run: |
          echo "ğŸ“Š Generando pÃ¡gina de estado..."
          node .bin/monitor/generate-status-page.js 