name: ğŸ›¡ï¸ AuditorÃ­a de Seguridad - Metaverso Web3

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 3 * * 1' # Cada lunes a las 3:00am
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Tipo de escaneo'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - smart-contracts
        - dependencies
        - assets
        - infrastructure

env:
  NODE_VERSION: '18'
  SOLIDITY_VERSION: '0.8.24'

jobs:
  # ğŸ” CODEQL ANALYSIS
  codeql:
    name: ğŸ” AnÃ¡lisis CodeQL
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ¾ Debug: Listar archivos raÃ­z
        run: ls -l
      - name: ğŸ¾ Debug: Listar archivos de dependencias
        run: |
          ls -l package.json || true
          ls -l requirements.txt || true
          ls -l engine/Cargo.toml || true
          
      - name: ğŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript, python
          queries: security-extended,security-and-quality
          
      - name: ğŸ” Autobuild
        uses: github/codeql-action/autobuild@v3
        
      - name: ğŸ“Š Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"
          
      - name: ğŸ“¤ Upload CodeQL Results
        uses: actions/upload-artifact@v4
        with:
          name: codeql-results
          path: |
            ~/.github/codeql/codeql_db/
            ~/.github/codeql/codeql_db.log

  # â›“ï¸ SMART CONTRACT SECURITY
  smart-contract-security:
    name: â›“ï¸ Seguridad Smart Contracts
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¾ Debug: Listar archivos protocol
        run: |
          ls -l protocol || true
          ls -l protocol/contracts || true
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Foundry
        run: |
          curl -L https://foundry.paradigm.xyz | bash
          source ~/.bashrc
          foundryup
          
      - name: ğŸ“¦ Install Security Tools
        run: |
          pip install slither-analyzer mythril
          npm install -g @openzeppelin/contracts-upgrades
          
      - name: ğŸ—ï¸ Compile Contracts
        run: |
          echo "ğŸ—ï¸ Compilando contratos..."
          cd protocol
          forge build
          
      - name: ğŸ›¡ï¸ Slither Analysis
        run: |
          echo "ğŸ›¡ï¸ AnÃ¡lisis con Slither..."
          cd protocol
          slither . --json slither-report.json --exclude-informational
          
      - name: ğŸ›¡ï¸ Mythril Analysis
        run: |
          echo "ğŸ›¡ï¸ AnÃ¡lisis con Mythril..."
          cd protocol
          mythril analyze contracts/core/WorldRegistry.sol --output json > mythril-report.json
          
      - name: ğŸ§ª Fuzzing Tests
        run: |
          echo "ğŸ§ª Tests de fuzzing..."
          cd protocol
          forge test --fuzz-runs 10000 --fuzz-seed 42
          
      - name: ğŸ” Reentrancy Check
        run: |
          echo "ğŸ” Verificando reentrancy..."
          cd protocol
          node .bin/security/check-reentrancy.js
          
      - name: ğŸ“Š Gas Optimization
        run: |
          echo "ğŸ“Š OptimizaciÃ³n de gas..."
          cd protocol
          forge test --gas-report > gas-report.txt
          
      - name: ğŸ“¤ Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: smart-contract-security
          path: |
            protocol/slither-report.json
            protocol/mythril-report.json
            protocol/gas-report.txt

  # ğŸ“¦ DEPENDENCY SECURITY
  dependency-security:
    name: ğŸ“¦ Seguridad de Dependencias
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¾ Debug: Listar archivos de dependencias
        run: |
          ls -l package.json || true
          ls -l requirements.txt || true
          ls -l engine/Cargo.toml || true
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Security Tools
        run: |
          npm install -g snyk auditjs
          pip install safety
          
      - name: ğŸ” NPM Audit
        run: |
          echo "ğŸ” AuditorÃ­a NPM..."
          npm audit --audit-level=moderate --json > npm-audit.json
          
      - name: ğŸ” Snyk Test
        run: |
          echo "ğŸ” Test Snyk..."
          snyk test --severity-threshold=high --json > snyk-report.json
          
      - name: ğŸ” Safety Check (Python)
        run: |
          echo "ğŸ” VerificaciÃ³n Safety..."
          safety check --json > safety-report.json || echo "No se encontraron dependencias Python"
          
      - name: ğŸ” Cargo Audit (Rust)
        run: |
          echo "ğŸ” AuditorÃ­a Cargo..."
          cd engine
          cargo audit --json > cargo-audit.json || echo "No se encontraron vulnerabilidades en Rust"
          
      - name: ğŸ“Š Dependency Graph
        run: |
          echo "ğŸ“Š Generando grafo de dependencias..."
          npm ls --json > dependency-tree.json
          
      - name: ğŸ“¤ Upload Dependency Reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-security
          path: |
            npm-audit.json
            snyk-report.json
            safety-report.json
            cargo-audit.json
            dependency-tree.json

  # ğŸ® ASSET SECURITY
  asset-security:
    name: ğŸ® Seguridad de Assets
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¾ Debug: Listar assets y scripts
        run: |
          ls -l assets || true
          ls -l .bin/security || true
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Asset Security Tools
        run: |
          npm install -g gltf-validator
          pip install pillow
          
      - name: ğŸ” Validate 3D Assets
        run: |
          echo "ğŸ” Validando assets 3D..."
          node .bin/security/validate-3d-assets.js
          
      - name: ğŸ” Check Asset Integrity
        run: |
          echo "ğŸ” Verificando integridad de assets..."
          node .bin/security/check-asset-integrity.js
          
      - name: ğŸ” Malware Scan
        run: |
          echo "ğŸ” Escaneo de malware..."
          node .bin/security/scan-assets-malware.js
          
      - name: ğŸ“Š Asset Report
        run: |
          echo "ğŸ“Š Generando reporte de assets..."
          node .bin/security/generate-asset-report.js

  # ğŸŒ INFRASTRUCTURE SECURITY
  infrastructure-security:
    name: ğŸŒ Seguridad de Infraestructura
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¾ Debug: Listar scripts de infraestructura
        run: ls -l .bin/security || true
        
      - name: ğŸ”§ Setup Security Tools
        run: |
          npm install -g @snyk/cli
          pip install bandit
          
      - name: ğŸ” Infrastructure as Code Scan
        run: |
          echo "ğŸ” Escaneando IaC..."
          node .bin/security/scan-infrastructure.js
          
      - name: ğŸ” Docker Security
        run: |
          echo "ğŸ” Seguridad de Docker..."
          node .bin/security/scan-docker.js
          
      - name: ğŸ” Kubernetes Security
        run: |
          echo "ğŸ” Seguridad de Kubernetes..."
          node .bin/security/scan-kubernetes.js
          
      - name: ğŸ” Network Security
        run: |
          echo "ğŸ” Seguridad de red..."
          node .bin/security/scan-network.js

  # ğŸ” SECRET SCANNING
  secret-scanning:
    name: ğŸ” Escaneo de Secretos
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¾ Debug: Listar scripts y baseline
        run: |
          ls -l .bin/security || true
          ls -l .secrets.baseline || touch .secrets.baseline
          
      - name: ğŸ“¦ Install Secret Scanning Tools
        run: |
          npm install -g trufflehog
          pip install detect-secrets
          
      - name: ğŸ” TruffleHog Scan
        run: |
          echo "ğŸ” Escaneo con TruffleHog..."
          trufflehog --json . > trufflehog-report.json
          
      - name: ğŸ” Detect Secrets
        run: |
          echo "ğŸ” DetecciÃ³n de secretos..."
          detect-secrets scan --baseline .secrets.baseline
          
      - name: ğŸ” Git History Scan
        run: |
          echo "ğŸ” Escaneo de historial Git..."
          node .bin/security/scan-git-history.js
          
      - name: ğŸ“Š Secret Report
        run: |
          echo "ğŸ“Š Generando reporte de secretos..."
          node .bin/security/generate-secret-report.js

  # ğŸ“Š SECURITY REPORT
  security-report:
    name: ğŸ“Š Reporte de Seguridad
    runs-on: ubuntu-latest
    needs: [codeql, smart-contract-security, dependency-security, asset-security, infrastructure-security, secret-scanning]
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Download All Reports
        uses: actions/download-artifact@v4
        with:
          name: codeql-results
          path: ./reports/codeql
        continue-on-error: true
          
      - name: ğŸ“¦ Download Smart Contract Reports
        uses: actions/download-artifact@v4
        with:
          name: smart-contract-security
          path: ./reports/smart-contracts
        continue-on-error: true
          
      - name: ğŸ“¦ Download Dependency Reports
        uses: actions/download-artifact@v4
        with:
          name: dependency-security
          path: ./reports/dependencies
        continue-on-error: true
          
      - name: ğŸ“Š Generate Security Report
        run: |
          echo "ğŸ“Š Generando reporte de seguridad..."
          node .bin/security/generate-security-report.js
          
      - name: ğŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: ./reports/security-report.json
          
      # - name: ğŸ“¢ Security Notifications
      #   run: |
      #     echo "ğŸ“¢ Enviando notificaciones de seguridad..."
      #     node .bin/security/send-security-notifications.js

  # ğŸš¨ CRITICAL ALERTS
  critical-alerts:
    name: ğŸš¨ Alertas CrÃ­ticas
    runs-on: ubuntu-latest
    needs: security-report
    if: failure()
    timeout-minutes: 5
    
    steps:
      - name: ğŸš¨ Critical Security Alert
        run: |
          echo "ğŸš¨ ALERTA CRÃTICA DE SEGURIDAD DETECTADA!"
          node .bin/security/send-critical-alert.js
          
      # - name: ğŸ“¢ Emergency Notifications
      #   run: |
      #     echo "ğŸ“¢ Enviando notificaciones de emergencia..."
      #     node .bin/security/send-emergency-notifications.js